# Statement of Work (SOW) - Dify API統合による融資申込システム改修

**プロジェクト名**: 融資申込システム Dify API統合改修  
**バージョン**: 1.0  
**作成日**: 2025年09月03日  
**承認日**: 未定  
**有効期限**: プロジェクト完了まで

---

## 1. プロジェクト概要

### 1.1 背景
現在の融資申込システムは、静的なレポート生成機能を提供していますが、AI駆動の動的なレポート生成とファイルアップロード機能が求められています。本プロジェクトでは、既存システムにDify APIを統合し、より高度な融資稟議書生成機能を実装します。

### 1.2 目的
- **AI駆動レポート生成**: Dify Workflow APIによる動的レポート生成
- **ファイルアップロード**: 決算書等の書類アップロード・解析機能
- **ユーザビリティ向上**: Vuetifyによる洗練されたUI/UX
- **リアルタイム更新**: SSEストリーミングによるリアルタイム進捗表示

### 1.3 プロジェクトスコープ
**含まれるもの**:
- Dify File Upload API統合
- Dify Workflow API統合
- SSEストリーミング実装
- Vuetifyコンポーネントの拡張
- 既存レポート生成システムの置換
- TypeScript型定義の追加

**含まれないもの**:
- Keycloak認証システムの変更
- データベーススキーマの変更
- 既存のページレイアウトの大幅な変更
- バックエンドインフラの変更

---

## 2. 現在のシステム分析

### 2.1 既存アーキテクチャ
```
Frontend: Nuxt3 + Vuetify + TypeScript
Authentication: Keycloak
API: /server/api/generate-report.post.ts (SSE対応)
UI Components: 既存のフォーム + 結果表示
```

### 2.2 現在の制限事項
- 静的なレポート生成ロジック
- ファイル処理機能の不足
- AIによる動的分析の欠如
- レポート品質の制限

### 2.3 改修対象ファイル
| ファイル/ディレクトリ | 改修内容 |
|---|---|
| `nuxt.config.ts` | Dify API環境変数設定 |
| `server/api/` | Dify API統合エンドポイント追加 |
| `composables/` | Dify API Composables追加 |
| `types/` | Dify API型定義追加 |
| `pages/index.vue` | UIコンポーネント更新 |
| `assets/styles/` | 新UIのスタイル追加 |

---

## 3. 技術要件

### 3.1 システム要件
| 項目 | 要件 |
|---|---|
| **Node.js** | 18.0.0以上 |
| **Nuxt3** | 3.17.4以上（既存バージョン維持） |
| **Vue** | 3.5.16以上（既存バージョン維持） |
| **Vuetify** | 3.8.7以上（既存バージョン維持） |
| **TypeScript** | 5.0以上 |

### 3.2 新規依存関係
```json
{
  "marked": "^5.0.0",           // Markdownレンダリング
  "dompurify": "^3.0.0"         // HTMLサニタイズ
}
```

### 3.3 環境変数
```bash
# .env (追加分)
DIFY_API_KEY=your_dify_api_key
DIFY_API_BASE_URL=https://api.dify.ai/v1
DIFY_WORKFLOW_API_ENDPOINT=https://api.dify.ai/v1/workflows/run
```

---

## 4. 実装タスク詳細

### 4.1 フェーズ1: 基盤整備（2営業日）

#### 4.1.1 環境設定・設定ファイル更新
**タスクID**: T001  
**担当**: 開発者  
**工数**: 4時間  

**成果物**:
- `nuxt.config.ts` 更新（環境変数設定）
- 新規依存関係の追加とインストール
- 環境変数テンプレート `.env.example` 作成

**詳細作業**:
```typescript
// nuxt.config.ts に追加
runtimeConfig: {
  difyApiKey: process.env.DIFY_API_KEY,
  difyApiBaseUrl: process.env.DIFY_API_BASE_URL,
  difyWorkflowApiEndpoint: process.env.DIFY_WORKFLOW_API_ENDPOINT,
}
```

#### 4.1.2 TypeScript型定義作成
**タスクID**: T002  
**担当**: 開発者  
**工数**: 4時間  

**成果物**:
- `types/dify.ts` - Dify API型定義
- 既存 `types/loan-application.ts` の拡張

**実装内容**:
- DifyUploadResponse インターフェース
- DifyWorkflowRequest インターフェース  
- DifyStreamEvent インターフェース
- DifyDisclosureItem インターフェース
- エラーハンドリング型定義

### 4.2 フェーズ2: サーバーAPI実装（3営業日）

#### 4.2.1 Dify File Upload API統合
**タスクID**: T003  
**担当**: 開発者  
**工数**: 8時間  

**成果物**:
- `server/api/dify/upload.post.ts`
- multipart/form-data処理
- エラーハンドリング

**実装仕様**:
```typescript
// リクエスト: multipart/form-data (file, user)
// レスポンス: DifyUploadResponse
// エラーハンドリング: HTTPステータス別処理
```

#### 4.2.2 Dify Workflow API統合
**タスクID**: T004  
**担当**: 開発者  
**工数**: 12時間  

**成果物**:
- `server/api/dify/workflow.post.ts`
- SSEストリーミング対応
- 既存 `generate-report.post.ts` の段階的移行

**実装仕様**:
```typescript
// リクエスト: DifyWorkflowRequest (JSON)
// レスポンス: SSE Stream
// イベント: text_chunk, workflow_finished, error
```

### 4.3 フェーズ3: Composables実装（3営業日）

#### 4.3.1 ファイルアップロード Composable
**タスクID**: T005  
**担当**: 開発者  
**工数**: 8時間  

**成果物**:
- `composables/useDifyUpload.ts`
- 進捗表示機能
- 複数ファイル対応
- エラーハンドリング

**機能仕様**:
- 単一/複数ファイルアップロード
- アップロード進捗監視
- バリデーション（ファイルサイズ、形式）
- キャンセル機能

#### 4.3.2 ワークフロー実行 Composable
**タスクID**: T006  
**担当**: 開発者  
**工数**: 10時間  

**成果物**:
- `composables/useDifyWorkflow.ts`
- SSEストリーミング処理
- リアルタイム結果更新
- エラーハンドリング

**機能仕様**:
- ワークフロー実行管理
- SSEイベント処理
- 部分的メッセージの蓄積
- 実行状態管理

### 4.4 フェーズ4: UI/UXコンポーネント実装（4営業日）

#### 4.4.1 ファイルアップロードUI
**タスクID**: T007  
**担当**: 開発者  
**工数**: 8時間  

**成果物**:
- `pages/index.vue` 更新（ファイル選択部分）
- `v-file-input` コンポーネント統合
- 進捗表示UI

**UI仕様**:
- ドラッグ&ドロップ対応（オプション）
- ファイル形式制限（PDF, DOCX, XLSX, CSV, TXT）
- ファイルサイズ制限（10MB）
- 複数ファイル選択対応
- 進捗バー表示

#### 4.4.2 結果表示UI改修
**タスクID**: T008  
**担当**: 開発者  
**工数**: 10時間  

**成果物**:
- ストリーミング結果表示コンポーネント
- Markdownレンダリング機能
- エラー状態表示

**UI仕様**:
- リアルタイムテキスト更新
- Markdown形式サポート
- ローディング状態表示
- エラーメッセージ表示
- スクロール最適化

#### 4.4.3 フォーム統合・レイアウト調整
**タスクID**: T009  
**担当**: 開発者  
**工数**: 6時間  

**成果物**:
- 既存フォームとDify機能の統合
- レスポンシブレイアウト調整
- バリデーション統合

### 4.5 フェーズ5: テスト・最適化（2営業日）

#### 4.5.1 統合テスト
**タスクID**: T010  
**担当**: 開発者  
**工数**: 6時間  

**テスト項目**:
- ファイルアップロード機能
- ワークフロー実行機能
- エラーハンドリング
- 既存機能との互換性

#### 4.5.2 パフォーマンス最適化
**タスクID**: T011  
**担当**: 開発者  
**工数**: 6時間  

**最適化項目**:
- ファイルアップロード並列処理
- SSEイベント処理最適化
- UIレスポンシブ性向上
- メモリリーク対策

---

## 5. スケジュール

### 5.1 全体スケジュール
```
フェーズ1: 基盤整備        [2営業日] Day 1-2
フェーズ2: サーバーAPI実装   [3営業日] Day 3-5
フェーズ3: Composables実装  [3営業日] Day 6-8
フェーズ4: UI/UX実装       [4営業日] Day 9-12
フェーズ5: テスト・最適化   [2営業日] Day 13-14

総工期: 14営業日（約3週間）
```

### 5.2 マイルストーン
| マイルストーン | 完了予定日 | 成果物 |
|---|---|---|
| **MS1: 基盤完了** | Day 2 | 環境設定・型定義完了 |
| **MS2: API統合完了** | Day 5 | Dify API統合完了 |
| **MS3: ロジック完了** | Day 8 | Composables実装完了 |
| **MS4: UI実装完了** | Day 12 | UIコンポーネント実装完了 |
| **MS5: プロジェクト完了** | Day 14 | テスト・最適化完了 |

---

## 6. 成果物

### 6.1 技術成果物
| カテゴリ | ファイル | 説明 |
|---|---|---|
| **設定** | `nuxt.config.ts` | Dify API環境変数設定 |
| **型定義** | `types/dify.ts` | Dify API型定義 |
| **サーバーAPI** | `server/api/dify/upload.post.ts` | ファイルアップロードAPI |
| **サーバーAPI** | `server/api/dify/workflow.post.ts` | ワークフローAPI |
| **Composables** | `composables/useDifyUpload.ts` | アップロードロジック |
| **Composables** | `composables/useDifyWorkflow.ts` | ワークフローロジック |
| **UI** | `pages/index.vue` (更新) | メインページ改修 |
| **スタイル** | `assets/styles/` (追加) | 新機能用スタイル |

### 6.2 ドキュメント成果物
| ドキュメント | 内容 |
|---|---|
| **API仕様書** | `documents/invoke-dify-api-spec.md` (既存) |
| **実装ガイド** | Dify API統合の実装詳細 |
| **テスト仕様書** | 統合テストケースと結果 |
| **運用手順書** | デプロイ・運用手順 |

---

## 7. リスク管理

### 7.1 技術リスク
| リスク | 影響度 | 発生確率 | 対策 |
|---|---|---|---|
| **Dify API制限** | 高 | 中 | API制限の事前確認・制限対応実装 |
| **SSE接続エラー** | 中 | 中 | 接続再試行・フォールバック機能 |
| **ファイルサイズ制限** | 中 | 低 | 事前バリデーション・分割アップロード |
| **既存機能との競合** | 高 | 低 | 段階的移行・互換性テスト |

### 7.2 スケジュールリスク
| リスク | 影響度 | 発生確率 | 対策 |
|---|---|---|---|
| **API仕様変更** | 高 | 低 | 公式ドキュメント定期確認 |
| **予期せぬ技術的課題** | 中 | 中 | 2日間のバッファ確保 |
| **テスト環境問題** | 中 | 中 | 開発環境での事前検証 |

### 7.3 品質リスク
| リスク | 影響度 | 発生確率 | 対策 |
|---|---|---|---|
| **レスポンス品質低下** | 中 | 中 | AI生成結果の検証機能 |
| **ファイル処理エラー** | 高 | 中 | 厳密なバリデーション・エラーハンドリング |
| **パフォーマンス劣化** | 中 | 中 | パフォーマンステスト・最適化 |

---

## 8. 品質保証

### 8.1 テスト戦略
| テストタイプ | 実施内容 |
|---|---|
| **単体テスト** | Composables関数のテスト |
| **統合テスト** | Dify API連携テスト |
| **UIテスト** | ユーザーインタラクションテスト |
| **パフォーマンステスト** | ファイルアップロード・ストリーミング性能 |

### 8.2 品質基準
| 項目 | 基準 |
|---|---|
| **応答時間** | ファイルアップロード: 10MB/30秒以下 |
| **可用性** | 99%以上の成功率 |
| **エラーハンドリング** | 全エラー状態でユーザーフレンドリーメッセージ |
| **アクセシビリティ** | WCAG 2.1 AA準拠 |

---

## 9. 前提条件・制約事項

### 9.1 前提条件
- Dify APIアカウント・APIキーの提供
- 既存システムの正常動作
- 開発環境へのアクセス権
- 必要な技術知識・経験

### 9.2 制約事項
- Dify API利用料金・制限の遵守
- 既存Keycloak認証システムの維持
- 現在のホスティング環境での動作
- 既存データ形式の互換性維持

### 9.3 依存関係
| 依存項目 | 提供者 | 必要時期 |
|---|---|---|
| **Dify APIアクセス** | クライアント | プロジェクト開始前 |
| **API仕様確認** | Dify公式 | フェーズ1開始前 |
| **テスト用データ** | クライアント | フェーズ4開始前 |

---

## 10. 予算・リソース

### 10.1 人的リソース
| 役割 | 工数 | 担当範囲 |
|---|---|---|
| **フルスタック開発者** | 88時間 | 全機能実装・テスト |

### 10.2 技術リソース
| リソース | 用途 | 費用 |
|---|---|---|
| **Dify API利用料** | AI処理・ファイル保存 | 使用量による |
| **開発環境** | 既存システム拡張 | 既存費用に含む |

### 10.3 外部サービス
| サービス | 目的 | 費用見積もり |
|---|---|---|
| **Dify API** | AI機能・ファイル処理 | 月額$50-200 (使用量による) |

---

## 11. 承認・変更管理

### 11.1 承認プロセス
1. **SOW承認**: プロジェクト開始前
2. **仕様確認**: 各フェーズ開始前
3. **成果物承認**: 各マイルストーン完了時
4. **最終承認**: プロジェクト完了時

### 11.2 変更管理
- **軽微な変更**: 担当者判断で実施
- **仕様変更**: 事前相談・承認必要
- **スケジュール変更**: 1日以上の遅延は事前報告

### 11.3 コミュニケーション
- **進捗報告**: 毎営業日終了時
- **問題報告**: 発生時即時
- **完了報告**: マイルストーン完了時

---

## 12. 付録

### 12.1 参考資料
- [Dify API仕様書](./invoke-dify-api-spec.md)
- [Nuxt3公式ドキュメント](https://nuxt.com/)
- [Vuetify公式ドキュメント](https://vuetifyjs.com/)

### 12.2 用語定義
| 用語 | 定義 |
|---|---|
| **Dify** | AIワークフロープラットフォーム |
| **SSE** | Server-Sent Events（サーバープッシュ技術） |
| **Composables** | Vue3のリアクティブロジック |
| **稟議書** | 融資申込の審査資料 |

### 12.3 連絡先
- **プロジェクトマネージャー**: [担当者名・連絡先]
- **技術リード**: [担当者名・連絡先]
- **クライアント窓口**: [担当者名・連絡先]

---

**文書管理**
- **文書ID**: SOW-DIFY-001
- **版数**: 1.0
- **最終更新**: 2025年09月03日
- **次回レビュー**: プロジェクト開始時